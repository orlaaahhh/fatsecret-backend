<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <title>Set User Goals</title>
    <style>
        body { 
            font-family: 'JetBrains Mono', monospace; 
            background: #f3f4f6; 
            padding: 20px; 
            display: flex;
            justify-content: center;
            color: #1f2937;
        }
        .container { 
            width: 100%;
            max-width: 600px;
            background: white; 
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.08); 
        }
        
        h1 { margin-top: 0; font-size: 1.4rem; margin-bottom: 25px; }
        
        /* Auth */
        .auth-bar { display: flex; gap: 10px; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
        
        label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.85rem; color: #374151; }
        .hint { font-size: 0.75rem; color: #6b7280; font-weight: 400; }

        input[type="password"], input[type="number"], select { 
            width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; 
            font-family: inherit; box-sizing: border-box; background: #f9fafb; font-size: 0.9rem;
        }
        input:focus, select:focus { outline: 2px solid #2563eb; border-color: transparent; background: #fff; }

        /* --- SLIDER CSS FIX --- */
        .slider-container { margin-bottom: 20px; }
        
        /* Stile base per tutti gli slider */
        input[type=range] {
            -webkit-appearance: none; 
            width: 100%; 
            background: transparent; 
            cursor: pointer;
            margin: 10px 0; /* Spazio per il pollice */
        }

        /* La barra (Track) */
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 8px;
            cursor: pointer;
            background: #cbd5e1; /* Grigio visibile */
            border-radius: 4px;
        }

        /* Il pallino (Thumb) */
        input[type=range]::-webkit-slider-thumb {
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #2563eb;
            cursor: pointer;
            -webkit-appearance: none;
            margin-top: -6px; /* Per centrarlo sulla barra (20px/2 - 8px/2 = 6px) */
            border: 2px solid #fff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        /* Colori specifici per i Macro */
        .slider-p::-webkit-slider-thumb { background: #F59E0B; }
        .slider-c::-webkit-slider-thumb { background: #10B981; }
        .slider-f::-webkit-slider-thumb { background: #8B5CF6; }

        /* Calorie Section */
        .cal-row { display: flex; gap: 15px; align-items: center; }
        .cal-input-wrap { width: 120px; }
        .cal-slider-wrap { flex-grow: 1; }

        /* Macro Section */
        .macro-section { background: #f8fafc; padding: 20px; border-radius: 8px; border: 1px solid #e2e8f0; margin-top: 20px; }
        .macro-row { margin-bottom: 15px; }
        .macro-header { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.9rem; }
        
        /* Bar Visualizer */
        .total-bar-wrap { height: 10px; background: #e2e8f0; border-radius: 5px; overflow: hidden; display: flex; margin-top: 20px; }
        .tb-seg { height: 100%; transition: width 0.3s ease; }
        .total-info { display: flex; justify-content: space-between; margin-top: 5px; font-size: 0.8rem; font-weight: 600; }

        /* Buttons */
        button { 
            width: 100%; padding: 12px; border: none; border-radius: 6px; cursor: pointer; 
            font-weight: bold; color: white; font-family: inherit; font-size: 0.95rem; margin-top: 20px;
        }
        .btn-blue { background: #2563eb; }
        .btn-blue:hover { background: #1d4ed8; }
        .btn-gray { background: #4b5563; width: auto; font-size: 0.8rem; padding: 8px 12px; margin-top: 0; } 

        .msg { margin-top: 15px; padding: 10px; border-radius: 6px; text-align: center; font-size: 0.9rem; display: none; }
        .msg.success { background: #dcfce7; color: #166534; display: block; }
        .msg.error { background: #fee2e2; color: #991b1b; display: block; }
    </style>
</head>
<body>

<div class="container">
    <h1>Nutrition Plan</h1>

    <div class="auth-bar">
        <input type="password" id="apiKey" placeholder="ADMIN API KEY">
        <button class="btn-gray" onclick="initPage()">Login</button>
    </div>

    <div style="margin-bottom: 20px;">
        <label>Select User</label>
        <select id="userSelect">
            <option value="">Insert API Key first...</option>
        </select>
    </div>

    <div class="slider-container">
        <label>Daily Calories <span class="hint">(kcal)</span></label>
        <div class="cal-row">
            <div class="cal-slider-wrap">
                <input type="range" id="range-cal" min="1000" max="4000" step="50" value="2000" oninput="syncCal('range')">
            </div>
            <div class="cal-input-wrap">
                <input type="number" id="input-cal" value="2000" oninput="syncCal('input')">
            </div>
        </div>
    </div>

    <div style="margin-bottom: 20px;">
        <label>Water Goal <span class="hint">(cups)</span></label>
        <input type="number" id="water" value="8">
    </div>

    <div class="macro-section">
        <label style="margin-bottom: 15px;">Macronutrient Split (%)</label>

        <div class="macro-row">
            <div class="macro-header">
                <span style="color:#F59E0B; font-weight:700;">Protein</span>
                <span id="disp-p">30% • 150g</span>
            </div>
            <input type="range" id="range-p" class="slider-p" min="0" max="100" value="30" oninput="recalc()">
        </div>

        <div class="macro-row">
            <div class="macro-header">
                <span style="color:#10B981; font-weight:700;">Carbs</span>
                <span id="disp-c">40% • 200g</span>
            </div>
            <input type="range" id="range-c" class="slider-c" min="0" max="100" value="40" oninput="recalc()">
        </div>

        <div class="macro-row">
            <div class="macro-header">
                <span style="color:#8B5CF6; font-weight:700;">Fats</span>
                <span id="disp-f">30% • 67g</span>
            </div>
            <input type="range" id="range-f" class="slider-f" min="0" max="100" value="30" oninput="recalc()">
        </div>

        <div class="total-bar-wrap">
            <div id="bar-p" class="tb-seg" style="background:#F59E0B; width:30%"></div>
            <div id="bar-c" class="tb-seg" style="background:#10B981; width:40%"></div>
            <div id="bar-f" class="tb-seg" style="background:#8B5CF6; width:30%"></div>
        </div>
        <div class="total-info">
            <span>Total:</span>
            <span id="total-pct">100%</span>
        </div>
    </div>

    <button class="btn-blue" onclick="saveGoals()">Update User Goals</button>
    <div id="msg" class="msg"></div>
</div>

<script>
    // Recupera Key salvata
    const savedKey = localStorage.getItem('adminKey');
    if(savedKey) {
        document.getElementById('apiKey').value = savedKey;
        initPage(); // Carica gli utenti se c'è la key
    }

    let gramsP = 0, gramsC = 0, gramsF = 0;

    // Sincronizza Slider Calorie <-> Input Numero
    function syncCal(source) {
        const range = document.getElementById('range-cal');
        const input = document.getElementById('input-cal');
        
        if(source === 'range') {
            input.value = range.value;
        } else {
            range.value = input.value;
        }
        recalc(); // Ricalcola i grammi macro
    }

    // Carica la lista utenti dal server
    async function initPage() {
        const key = document.getElementById('apiKey').value;
        localStorage.setItem('adminKey', key);
        
        const select = document.getElementById('userSelect');
        
        try {
            const res = await fetch('/admin/users-list', {
                headers: { 'x-admin-key': key }
            });
            
            if(res.status === 401) {
                alert("API Key Errata");
                return;
            }

            const data = await res.json();
            
            // Pulisci e riempi la select
            select.innerHTML = '<option value="">-- Select a User --</option>';
            data.users.forEach(u => {
                const opt = document.createElement('option');
                opt.value = u.email;
                opt.innerText = u.email;
                select.appendChild(opt);
            });

        } catch (e) {
            console.error(e);
            alert("Errore caricamento utenti. Controlla server.");
        }
    }

    function recalc() {
        const cal = Number(document.getElementById('input-cal').value) || 0;
        
        const pctP = Number(document.getElementById('range-p').value);
        const pctC = Number(document.getElementById('range-c').value);
        const pctF = Number(document.getElementById('range-f').value);

        // Calcolo Grammi
        gramsP = Math.round((cal * (pctP / 100)) / 4);
        gramsC = Math.round((cal * (pctC / 100)) / 4);
        gramsF = Math.round((cal * (pctF / 100)) / 9);

        // Update UI Text
        document.getElementById('disp-p').innerText = `${pctP}% • ${gramsP}g`;
        document.getElementById('disp-c').innerText = `${pctC}% • ${gramsC}g`;
        document.getElementById('disp-f').innerText = `${pctF}% • ${gramsF}g`;

        // Update Visual Bar
        document.getElementById('bar-p').style.width = pctP + '%';
        document.getElementById('bar-c').style.width = pctC + '%';
        document.getElementById('bar-f').style.width = pctF + '%';

        // Check Total
        const total = pctP + pctC + pctF;
        const totalEl = document.getElementById('total-pct');
        totalEl.innerText = total + "%";
        
        if(total !== 100) {
            totalEl.style.color = "#DC2626"; 
            totalEl.innerText += " ⚠️";
        } else {
            totalEl.style.color = "#166534"; 
        }
    }

    async function saveGoals() {
        const key = document.getElementById('apiKey').value;
        const email = document.getElementById('userSelect').value; // Prende valore dalla Select
        
        const msg = document.getElementById('msg');
        msg.style.display = 'none';

        const totalPct = Number(document.getElementById('range-p').value) + 
                         Number(document.getElementById('range-c').value) + 
                         Number(document.getElementById('range-f').value);

        if(totalPct !== 100) return alert("Total percentages must equal 100%");
        if(!email) return alert("Please select a user");

        const btn = document.querySelector('.btn-blue');
        btn.innerText = "Syncing...";
        btn.disabled = true;

        try {
            const payload = {
                email: email,
                calories: Number(document.getElementById('input-cal').value),
                water: Number(document.getElementById('water').value),
                protein: gramsP,
                carbs: gramsC,
                fat: gramsF
            };

            const res = await fetch('/admin/goals', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'x-admin-key': key },
                body: JSON.stringify(payload)
            });

            const data = await res.json();

            if(res.ok) {
                msg.innerText = `✅ Goals updated for ${email}`;
                msg.className = "msg success";
            } else {
                msg.innerText = "❌ Error: " + (data.error || "Unknown");
                msg.className = "msg error";
            }
        } catch (e) {
            msg.innerText = "❌ Connection Error";
            msg.className = "msg error";
        } finally {
            btn.innerText = "Update User Goals";
            btn.disabled = false;
        }
    }

    // Init
    recalc();
</script>

</body>
</html>
