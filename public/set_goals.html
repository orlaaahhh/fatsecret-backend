<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <title>Set User Goals</title>
    <style>
        body { 
            font-family: 'JetBrains Mono', monospace; 
            background: #f3f4f6; 
            padding: 20px; 
            display: flex;
            justify-content: center;
            color: #1f2937;
        }
        .container { 
            width: 100%;
            max-width: 550px;
            background: white; 
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.08); 
        }
        
        h1 { margin-top: 0; font-size: 1.4rem; margin-bottom: 25px; display:flex; align-items:center; gap:10px;}
        
        /* Inputs & Auth */
        .auth-bar { display: flex; gap: 10px; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
        
        label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.85rem; color: #4b5563; }
        .hint { font-size: 0.75rem; color: #9ca3af; font-weight: 400; margin-left: 5px; }

        input[type="text"], input[type="email"], input[type="password"], input[type="number"] { 
            width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; 
            font-family: inherit; box-sizing: border-box; background: #f9fafb;
        }
        input:focus { outline: 2px solid #2563eb; border-color: transparent; background: #fff; }

        /* Main Grid */
        .main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px; }

        /* Macro Sliders Section */
        .macro-section { background: #f8fafc; padding: 20px; border-radius: 8px; border: 1px solid #e2e8f0; }
        
        .macro-row { margin-bottom: 15px; }
        .macro-header { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .macro-name { font-weight: 700; font-size: 0.9rem; }
        .macro-val { font-weight: 600; font-size: 0.9rem; color: #2563eb; }

        /* Custom Range Slider */
        input[type=range] {
            -webkit-appearance: none; width: 100%; background: transparent; cursor: pointer;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 6px; background: #e2e8f0; border-radius: 3px;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 18px; width: 18px; border-radius: 50%;
            background: #2563eb; margin-top: -6px; border: 2px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        /* Colori Specifici Macro */
        .slider-p::-webkit-slider-thumb { background: #F59E0B; } /* Protein Orange */
        .text-p { color: #F59E0B; }
        
        .slider-c::-webkit-slider-thumb { background: #10B981; } /* Carbs Green */
        .text-c { color: #10B981; }

        .slider-f::-webkit-slider-thumb { background: #8B5CF6; } /* Fat Purple */
        .text-f { color: #8B5CF6; }

        /* Total Bar */
        .total-bar-wrap { height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; display: flex; margin-top: 20px; }
        .tb-seg { height: 100%; transition: width 0.3s ease; }
        .total-info { display: flex; justify-content: space-between; margin-top: 5px; font-size: 0.8rem; font-weight: 600; }
        
        /* Bottoni */
        button { 
            width: 100%; padding: 12px; border: none; border-radius: 6px; cursor: pointer; 
            font-weight: bold; color: white; font-family: inherit; font-size: 0.95rem; margin-top: 20px;
        }
        .btn-blue { background: #2563eb; }
        .btn-blue:hover { background: #1d4ed8; }
        .btn-gray { background: #4b5563; width: auto; font-size: 0.85rem; padding: 8px 16px; margin-top:0; } 

        .msg { margin-top: 15px; padding: 10px; border-radius: 6px; text-align: center; font-size: 0.9rem; display: none; }
        .msg.success { background: #dcfce7; color: #166534; display: block; }
        .msg.error { background: #fee2e2; color: #991b1b; display: block; }
    </style>
</head>
<body>

<div class="container">
    <h1>üéØ Nutrition Plan</h1>

    <div class="auth-bar">
        <input type="password" id="apiKey" placeholder="ADMIN API KEY">
        <button class="btn-gray" onclick="saveKey()">Save Key</button>
    </div>

    <div style="margin-bottom: 20px;">
        <label>User Email</label>
        <input type="email" id="email" placeholder="client@example.com">
    </div>

    <div class="main-grid">
        <div>
            <label>Daily Calories <span class="hint">(kcal)</span></label>
            <input type="number" id="calories" value="2000" oninput="recalc()">
        </div>
        <div>
            <label>Daily Water <span class="hint">(cups)</span></label>
            <input type="number" id="water" value="8">
        </div>
    </div>

    <div class="macro-section">
        <label style="margin-bottom: 15px;">Macronutrient Split</label>

        <div class="macro-row">
            <div class="macro-header">
                <span class="macro-name text-p">Protein (4 cal/g)</span>
                <span class="macro-val" id="disp-p">30% ‚Ä¢ 150g</span>
            </div>
            <input type="range" id="range-p" class="slider-p" min="0" max="100" value="30" oninput="recalc()">
        </div>

        <div class="macro-row">
            <div class="macro-header">
                <span class="macro-name text-c">Carbs (4 cal/g)</span>
                <span class="macro-val" id="disp-c">40% ‚Ä¢ 200g</span>
            </div>
            <input type="range" id="range-c" class="slider-c" min="0" max="100" value="40" oninput="recalc()">
        </div>

        <div class="macro-row">
            <div class="macro-header">
                <span class="macro-name text-f">Fats (9 cal/g)</span>
                <span class="macro-val" id="disp-f">30% ‚Ä¢ 67g</span>
            </div>
            <input type="range" id="range-f" class="slider-f" min="0" max="100" value="30" oninput="recalc()">
        </div>

        <div class="total-bar-wrap">
            <div id="bar-p" class="tb-seg" style="background:#F59E0B; width:30%"></div>
            <div id="bar-c" class="tb-seg" style="background:#10B981; width:40%"></div>
            <div id="bar-f" class="tb-seg" style="background:#8B5CF6; width:30%"></div>
        </div>
        <div class="total-info">
            <span>Total Split:</span>
            <span id="total-pct">100%</span>
        </div>
    </div>

    <button class="btn-blue" onclick="saveGoals()">Update App Goals</button>
    <div id="msg" class="msg"></div>
</div>

<script>
    const savedKey = localStorage.getItem('adminKey');
    if(savedKey) document.getElementById('apiKey').value = savedKey;

    // Globals per i calcoli
    let gramsP = 0, gramsC = 0, gramsF = 0;

    function saveKey() {
        localStorage.setItem('adminKey', document.getElementById('apiKey').value);
        alert("Key saved!");
    }

    function recalc() {
        const cal = Number(document.getElementById('calories').value) || 0;
        
        const pctP = Number(document.getElementById('range-p').value);
        const pctC = Number(document.getElementById('range-c').value);
        const pctF = Number(document.getElementById('range-f').value);

        // Calcolo Grammi: (Calorie Totali * Percentuale) / Fattore di conversione
        gramsP = Math.round((cal * (pctP / 100)) / 4);
        gramsC = Math.round((cal * (pctC / 100)) / 4);
        gramsF = Math.round((cal * (pctF / 100)) / 9);

        // Update UI Text
        document.getElementById('disp-p').innerText = `${pctP}% ‚Ä¢ ${gramsP}g`;
        document.getElementById('disp-c').innerText = `${pctC}% ‚Ä¢ ${gramsC}g`;
        document.getElementById('disp-f').innerText = `${pctF}% ‚Ä¢ ${gramsF}g`;

        // Update Visual Bar
        document.getElementById('bar-p').style.width = pctP + '%';
        document.getElementById('bar-c').style.width = pctC + '%';
        document.getElementById('bar-f').style.width = pctF + '%';

        // Check Total
        const total = pctP + pctC + pctF;
        const totalEl = document.getElementById('total-pct');
        totalEl.innerText = total + "%";
        
        if(total !== 100) {
            totalEl.style.color = "#DC2626"; // Red warning
            totalEl.innerText += " ‚ö†Ô∏è (Must be 100)";
        } else {
            totalEl.style.color = "#166534"; // Green ok
        }
    }

    async function saveGoals() {
        const key = document.getElementById('apiKey').value;
        const email = document.getElementById('email').value;
        const totalPct = Number(document.getElementById('range-p').value) + 
                         Number(document.getElementById('range-c').value) + 
                         Number(document.getElementById('range-f').value);
        
        const msg = document.getElementById('msg');
        msg.style.display = 'none';

        if(totalPct !== 100) {
            alert("Please adjust sliders so the total equals 100%.");
            return;
        }
        if(!email || !key) return alert("Missing Email or API Key");

        const btn = document.querySelector('.btn-blue');
        btn.innerText = "Syncing...";
        btn.disabled = true;

        try {
            // Inviamo i GRAMMI calcolati, non le percentuali
            const payload = {
                email: email.trim().toLowerCase(),
                calories: Number(document.getElementById('calories').value),
                water: Number(document.getElementById('water').value),
                protein: gramsP,
                carbs: gramsC,
                fat: gramsF
            };

            const res = await fetch('/admin/goals', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'x-admin-key': key },
                body: JSON.stringify(payload)
            });

            const data = await res.json();

            if(res.ok) {
                msg.innerText = `‚úÖ Goals updated for ${email}`;
                msg.className = "msg success";
            } else {
                msg.innerText = "‚ùå Error: " + (data.error || "Unknown");
                msg.className = "msg error";
            }
        } catch (e) {
            msg.innerText = "‚ùå Connection Error";
            msg.className = "msg error";
        } finally {
            btn.innerText = "Update App Goals";
            btn.disabled = false;
        }
    }

    // Init calculation on load
    recalc();
</script>

</body>
</html>
