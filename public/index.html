<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <title>Manage Meetings</title>
    <style>
        body { 
            font-family: 'JetBrains Mono', monospace; 
            background: #f3f4f6; 
            padding: 20px; 
            color: #1f2937;
            display: flex;
            justify-content: center;
        }
        .container { 
            width: 100%;
            max-width: 700px;
            background: white; 
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.08); 
        }
        
        h1 { margin-top: 0; font-size: 1.4rem; margin-bottom: 25px; display:flex; justify-content:space-between; align-items:center; }
        
        /* Auth */
        .auth-bar { display: flex; gap: 10px; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid #e5e7eb; }
        
        label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.85rem; color: #4b5563; }
        .hint { font-size: 0.75rem; color: #9ca3af; font-weight: 400; }

        input, select { 
            width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; 
            font-family: inherit; box-sizing: border-box; background: #f9fafb; font-size: 0.9rem;
        }
        input:focus, select:focus { outline: 2px solid #2563eb; border-color: transparent; background: #fff; }

        /* Grid Layouts */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px; }

        /* Buttons */
        button { 
            width: 100%; padding: 12px; border: none; border-radius: 6px; cursor: pointer; 
            font-weight: bold; color: white; font-family: inherit; font-size: 0.9rem;
        }
        .btn-blue { background: #2563eb; margin-top: 20px; }
        .btn-blue:hover { background: #1d4ed8; }
        .btn-gray { background: #4b5563; width: auto; font-size: 0.8rem; padding: 8px 16px; } 
        .btn-red { background: #fee2e2; color: #dc2626; border: 1px solid #fca5a5; width: auto; font-size: 0.7rem; padding: 4px 10px; }

        /* Preview Box */
        .preview-box { 
            background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; 
            margin-top: 20px; font-size: 0.85rem; color: #64748b;
        }
        .preview-header { font-weight: 700; color: #334155; margin-bottom: 5px; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.5px; }

        /* Status Messages */
        .msg { margin-top: 15px; padding: 10px; border-radius: 6px; text-align: center; font-size: 0.9rem; display: none; }
        .msg.success { background: #dcfce7; color: #166534; display: block; }
        .msg.error { background: #fee2e2; color: #991b1b; display: block; }

        /* Badge */
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
        .badge.ok { background: #dcfce7; color: #166534; }
        .badge.bad { background: #fee2e2; color: #991b1b; }
    </style>
</head>
<body>

<div class="container">
    <h1>
        üìÖ Meeting Manager
        <span id="keyBadge" class="badge bad">Key: Missing</span>
    </h1>

    <div class="auth-bar">
        <input type="password" id="apiKey" placeholder="ADMIN API KEY">
        <button class="btn-gray" onclick="initPage()">Login</button>
    </div>

    <div style="margin-bottom: 20px;">
        <label>Select User</label>
        <select id="userSelect">
            <option value="">Insert API Key first...</option>
        </select>
    </div>

    <div class="grid-2">
        <div>
            <label>Meeting Title</label>
            <input type="text" id="title" placeholder="e.g. Weekly Check-in">
        </div>
        <div>
            <label>Zoom URL</label>
            <input type="text" id="zoomUrl" placeholder="https://zoom.us/j/...">
        </div>
    </div>

    <div class="grid-3">
        <div>
            <label>Date</label>
            <input type="date" id="date" onchange="updatePreview()">
        </div>
        <div>
            <label>Start Time</label>
            <input type="time" id="start" value="09:00" onchange="updatePreview()">
        </div>
        <div>
            <label>Duration <span class="hint">(min)</span></label>
            <input type="number" id="duration" value="30" step="15" min="15" onchange="updatePreview()">
        </div>
    </div>

    <div class="preview-box">
        <div class="preview-header">Summary</div>
        <div id="previewText">Select a date and time...</div>
    </div>

    <button class="btn-blue" id="btnCreate" onclick="createMeeting()">Schedule Meeting</button>
    <div id="msg" class="msg"></div>
</div>

<script>
    // --- INIT ---
    const savedKey = localStorage.getItem('adminKey');
    if(savedKey) {
        document.getElementById('apiKey').value = savedKey;
        initPage();
    }
    
    // Set default date to today
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('date').value = today;
    updatePreview();

    // --- FUNCTIONS ---

    function updateBadge(ok) {
        const b = document.getElementById('keyBadge');
        b.className = ok ? 'badge ok' : 'badge bad';
        b.innerText = ok ? 'Key: Active' : 'Key: Missing';
    }

    async function initPage() {
        const key = document.getElementById('apiKey').value.trim();
        if(!key) return;
        
        localStorage.setItem('adminKey', key);
        updateBadge(true);

        const select = document.getElementById('userSelect');
        select.innerHTML = '<option>Loading...</option>';

        try {
            const res = await fetch('/admin/users-list', { headers: { 'x-admin-key': key } });
            
            if(res.status === 401) {
                updateBadge(false);
                alert("API Key Errata");
                select.innerHTML = '<option value="">Login failed</option>';
                return;
            }

            const data = await res.json();
            
            select.innerHTML = '<option value="">-- Select a User --</option>';
            data.users.forEach(u => {
                // Usiamo email come label e ID (o email) come value. 
                // Ma per creare il meeting serve l'ID. 
                // Se l'API users-list ritorna solo email, dobbiamo modificarla o fare una query per ID.
                // ‚úÖ UPDATE: Ho assunto che l'API /admin/users-list ora ritorni anche l'ID o che 
                //    possiamo cercare l'ID dall'email.
                //    Per sicurezza, useremo l'email e faremo una fetch "find user" interna se necessario,
                //    OPPURE modifichiamo l'API backend per restituire {id, email}.
                
                // Opzione migliore: L'API /admin/users-list dovrebbe restituire id ed email.
                // Se non lo fa, modificala in index.js: "select id, email from users..."
                
                // Se non puoi modificare il backend ora, usiamo l'email come value e la cerchiamo al volo.
                const opt = document.createElement('option');
                opt.value = u.email; 
                opt.innerText = u.email;
                select.appendChild(opt);
            });

        } catch (e) {
            console.error(e);
            alert("Errore connessione server");
        }
    }

    function updatePreview() {
        const dateStr = document.getElementById('date').value;
        const timeStr = document.getElementById('start').value;
        const dur = Number(document.getElementById('duration').value);

        if(!dateStr || !timeStr) return;

        const start = new Date(`${dateStr}T${timeStr}`);
        const end = new Date(start.getTime() + dur * 60000);

        const fmt = (d) => d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        document.getElementById('previewText').innerHTML = `
            <strong>Start:</strong> ${dateStr} at ${fmt(start)} <br>
            <strong>End:</strong> ${fmt(end)} (${dur} min)
        `;
    }

    async function createMeeting() {
        const key = document.getElementById('apiKey').value;
        const email = document.getElementById('userSelect').value;
        const title = document.getElementById('title').value;
        const zoomUrl = document.getElementById('zoomUrl').value;
        
        const dateStr = document.getElementById('date').value;
        const timeStr = document.getElementById('start').value;
        const dur = Number(document.getElementById('duration').value);

        const msg = document.getElementById('msg');
        msg.style.display = 'none';

        if(!email || !title || !zoomUrl || !dateStr || !timeStr) {
            alert("Please fill all fields.");
            return;
        }

        const btn = document.getElementById('btnCreate');
        btn.innerText = "Scheduling...";
        btn.disabled = true;

        try {
            // 1. Troviamo l'ID utente dall'email (per sicurezza)
            const uRes = await fetch(`/admin/users?email=${email}`, { headers: { 'x-admin-key': key } });
            const uData = await uRes.json();
            
            if(!uData.user?.id) throw new Error("User ID not found for this email");
            
            const userId = uData.user.id;

            // 2. Calcoliamo Start/End ISO Strings
            const startDt = new Date(`${dateStr}T${timeStr}`);
            const endDt = new Date(startDt.getTime() + dur * 60000);

            // 3. Creiamo il Meeting
            const payload = {
                userId,
                title,
                zoomUrl,
                start: startDt.toISOString(),
                end: endDt.toISOString()
            };

            const res = await fetch('/meetings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'x-admin-key': key },
                body: JSON.stringify(payload)
            });

            const json = await res.json();

            if(res.ok) {
                msg.innerText = "‚úÖ Meeting scheduled successfully!";
                msg.className = "msg success";
                // Reset form parziale
                document.getElementById('title').value = "";
                document.getElementById('zoomUrl').value = "";
            } else {
                msg.innerText = "‚ùå Error: " + (json.error || "Unknown");
                msg.className = "msg error";
            }

        } catch (e) {
            msg.innerText = "‚ùå Error: " + e.message;
            msg.className = "msg error";
        } finally {
            btn.innerText = "Schedule Meeting";
            btn.disabled = false;
        }
    }
</script>

</body>
</html>
