<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Admin • Zoom Meetings</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root{
        --bg:#0b0f19;
        --card:#0f1626;
        --line:rgba(255,255,255,0.08);
        --text:#eaf0ff;
        --muted:rgba(234,240,255,0.62);
        --accent:#5b8cff;
        --danger:#ff4d6d;
        --shadow: 0 18px 60px rgba(0,0,0,0.45);
        --r:16px;
      }
      *{ box-sizing:border-box; }
      body{
        margin:0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
        background:
          radial-gradient(900px 420px at 20% -10%, rgba(91,140,255,0.18), transparent 60%),
          radial-gradient(900px 420px at 90% 0%, rgba(35,193,122,0.10), transparent 55%),
          var(--bg);
        color:var(--text);
      }
      .wrap{
        max-width: 900px;
        margin: 28px auto;
        padding: 0 14px 28px;
      }
      .top{
        display:flex;
        align-items:flex-start;
        justify-content:space-between;
        gap:12px;
        margin-bottom:14px;
      }
      .title{
        font-size:16px;
        font-weight:900;
        letter-spacing:0.2px;
      }
      .sub{
        margin-top:6px;
        color:var(--muted);
        font-size:12px;
        font-weight:650;
      }
      .grid{
        display:grid;
        grid-template-columns: 1fr 1fr;
        gap:12px;
      }
      @media (max-width: 900px){
        .grid{ grid-template-columns: 1fr; }
      }
      .card{
        background: rgba(15,22,38,0.72);
        border:1px solid var(--line);
        border-radius: var(--r);
        padding:14px;
        box-shadow: var(--shadow);
        backdrop-filter: blur(8px);
      }
      .cardHeader{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:10px;
        margin-bottom:10px;
      }
      h3{
        margin:0;
        font-size:13px;
        font-weight:900;
        letter-spacing:0.2px;
      }
      .divider{
        height:1px;
        background: rgba(255,255,255,0.08);
        margin: 12px 0;
      }
      label{
        display:block;
        margin: 10px 0 6px;
        color: var(--muted);
        font-size:12px;
        font-weight:850;
      }
      input{
        width:100%;
        padding:12px 12px;
        border-radius: 14px;
        border:1px solid rgba(255,255,255,0.10);
        background: rgba(255,255,255,0.06);
        color: var(--text);
        outline:none;
        font-weight:750;
      }
      input::placeholder{ color: rgba(234,240,255,0.35); font-weight:700; }
      input:focus{
        border-color: rgba(91,140,255,0.45);
        box-shadow: 0 0 0 4px rgba(91,140,255,0.14);
      }
      .row{
        display:flex;
        gap:10px;
      }
      .row > *{ flex:1; }
      button{
        border:0;
        cursor:pointer;
        border-radius: 14px;
        padding: 12px 14px;
        font-weight:900;
        letter-spacing:0.2px;
        user-select:none;
      }
      .btn{
        background: rgba(255,255,255,0.06);
        border:1px solid rgba(255,255,255,0.12);
        color: var(--text);
      }
      .btn:hover{ background: rgba(255,255,255,0.09); }
      .btnPrimary{
        background: rgba(91,140,255,0.18);
        border:1px solid rgba(91,140,255,0.32);
        color: var(--text);
      }
      .btnPrimary:hover{ background: rgba(91,140,255,0.22); }
      .btnDanger{
        background: rgba(255,77,109,0.12);
        border:1px solid rgba(255,77,109,0.28);
        color: var(--text);
      }
      .btnDanger:hover{ background: rgba(255,77,109,0.16); }
      .btnRow{
        display:flex;
        gap:10px;
        margin-top:12px;
      }
      .mono{
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        font-size: 12px;
      }
      .out{
        background: rgba(0,0,0,0.35);
        border:1px solid rgba(255,255,255,0.10);
        border-radius: 14px;
        padding: 12px;
        overflow:auto;
        min-height: 212px;
        white-space: pre-wrap;
        word-break: break-word;
      }
      .badge{
        display:inline-flex;
        align-items:center;
        gap:8px;
        padding:8px 10px;
        border-radius:999px;
        border:1px solid rgba(255,255,255,0.12);
        background: rgba(255,255,255,0.06);
        font-size:12px;
        font-weight:900;
        color: var(--muted);
      }
      .badge.ok{
        border-color: rgba(35,193,122,0.26);
        background: rgba(35,193,122,0.12);
        color: rgba(234,240,255,0.88);
      }
      .badge.bad{
        border-color: rgba(255,77,109,0.26);
        background: rgba(255,77,109,0.10);
        color: rgba(234,240,255,0.88);
      }
      .status{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:10px;
        margin-top:10px;
      }
      .small{
        color: var(--muted);
        font-size:12px;
        font-weight:750;
      }
      .ghost{ color: rgba(234,240,255,0.44); }
    </style>
  </head>

  <body>
    <div class="wrap">
      <div class="top">
        <div>
          <div class="title">Admin • Zoom Meetings</div>
          <div class="sub">Create meetings for a user. Date/time follows your device timezone (Boston / New York).</div>
        </div>
        <span class="badge" id="keyBadge">Admin key: not set</span>
      </div>

      <div class="grid">
        <!-- Left: form -->
        <div class="card">
          <div class="cardHeader">
            <h3>Create</h3>
            <button class="btnDanger" id="btnReset" type="button">Reset</button>
          </div>

          <label>Admin API Key</label>
          <input id="adminKey" placeholder="ADMIN_API_KEY" autocomplete="off" />

          <div class="divider"></div>

          <label>User email</label>
          <div class="row">
            <input id="email" placeholder="user@email.com" autocomplete="off" />
            <button class="btn" id="btnFind" type="button">Find</button>
          </div>

          <label>User ID</label>
          <input id="userId" placeholder="auto-filled" inputmode="numeric" />

          <div class="divider"></div>

          <label>Title</label>
          <input id="title" placeholder="Weekly Check-in" />

          <label>Zoom URL</label>
          <input id="zoomUrl" placeholder="https://zoom.us/j/..." />

          <div class="row">
            <div>
              <label>Date</label>
              <input id="date" type="date" />
            </div>
            <div>
              <label>Start</label>
              <input id="start" type="time" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>Duration (min)</label>
              <input id="duration" type="number" min="5" step="5" value="30" />
            </div>
            <div>
              <label>End (optional)</label>
              <input id="end" type="time" />
            </div>
          </div>

          <div class="status">
            <span class="badge" id="previewBadge">Preview</span>
            <span class="small mono" id="previewText"><span class="ghost">Start:</span> -   <span class="ghost">End:</span> -</span>
          </div>

          <div class="btnRow">
            <button class="btnPrimary" id="btnCreate" type="button">Create meeting</button>
          </div>
        </div>

        <!-- Right: output -->
        <div class="card">
          <div class="cardHeader">
            <h3>Response</h3>
            <span class="small mono">POST /meetings</span>
          </div>

          <div class="out mono" id="out">-</div>
        </div>
      </div>
    </div>

    <script>
      const $ = (id) => document.getElementById(id);
      const outEl = $("out");
      const previewText = $("previewText");
      const previewBadge = $("previewBadge");
      const keyBadge = $("keyBadge");

      function out(x){
        outEl.textContent = typeof x === "string" ? x : JSON.stringify(x, null, 2);
      }

      function adminKey(){
        return ($("adminKey").value || "").trim();
      }

      function syncKeyBadge(){
        const k = adminKey();
        if (k.length >= 8) {
          keyBadge.className = "badge ok";
          keyBadge.textContent = "Admin key: set";
        } else {
          keyBadge.className = "badge bad";
          keyBadge.textContent = "Admin key: not set";
        }
      }

      function headers(){
        const k = adminKey();
        if (!k) throw new Error("Missing admin key.");
        return { "x-admin-key": k };
      }

      function parseLocalDateTime(dateStr, timeStr){
        const [y,m,d] = dateStr.split("-").map(Number);
        const [hh,mm] = timeStr.split(":").map(Number);
        const dt = new Date();
        dt.setFullYear(y, m-1, d);
        dt.setHours(hh, mm, 0, 0);
        return dt;
      }

      function setBadge(ok){
        previewBadge.className = "badge " + (ok ? "ok" : "bad");
        previewBadge.textContent = ok ? "✅ Ready" : "⚠️ Check";
      }

      function computeStartEnd(){
        const dateStr = $("date").value;
        const startStr = $("start").value;
        const endStr = $("end").value;
        const dur = Number($("duration").value || 30);

        if (!dateStr || !startStr) return null;

        const start = parseLocalDateTime(dateStr, startStr);
        let end;

        if (endStr){
          end = parseLocalDateTime(dateStr, endStr);
        } else {
          end = new Date(start.getTime() + Math.max(5, dur) * 60 * 1000);
        }

        if (!(end > start)) return { bad:true, start, end };
        return { start, end };
      }

      function updatePreview(){
        const r = computeStartEnd();
        if (!r){
          previewText.innerHTML = `<span class="ghost">Start:</span> - &nbsp;&nbsp; <span class="ghost">End:</span> -`;
          setBadge(false);
          return;
        }
        const startISO = r.start.toISOString();
        const endISO = r.end.toISOString();
        previewText.textContent = `Start: ${startISO}   End: ${endISO}`;
        setBadge(!r.bad);
      }

      function initDefaults(){
        const now = new Date();
        const yyyy = now.getFullYear();
        const mm = String(now.getMonth()+1).padStart(2,"0");
        const dd = String(now.getDate()).padStart(2,"0");
        $("date").value = `${yyyy}-${mm}-${dd}`;

        const rounded = new Date(now);
        rounded.setMinutes(Math.ceil(rounded.getMinutes() / 15) * 15);
        rounded.setSeconds(0,0);
        const hh = String(rounded.getHours()).padStart(2,"0");
        const mi = String(rounded.getMinutes()).padStart(2,"0");
        $("start").value = `${hh}:${mi}`;

        $("duration").value = "30";
        $("end").value = "";
      }

      ["adminKey"].forEach((id)=>{
        $(id).addEventListener("input", () => { syncKeyBadge(); });
      });

      ["date","start","end","duration"].forEach((id)=>{
        $(id).addEventListener("input", updatePreview);
        $(id).addEventListener("change", updatePreview);
      });

      $("btnReset").onclick = () => {
        $("adminKey").value = "";
        $("email").value = "";
        $("userId").value = "";
        $("title").value = "";
        $("zoomUrl").value = "";
        initDefaults();
        out("-");
        syncKeyBadge();
        updatePreview();
      };

      $("btnFind").onclick = async () => {
        try{
          const email = $("email").value.trim().toLowerCase();
          if (!email) return out("Enter an email.");
          const r = await fetch(`/admin/users?email=${encodeURIComponent(email)}`, { headers: headers() });
          const j = await r.json().catch(()=> ({}));
          out(j);
          if (!r.ok) throw new Error(j?.error ?? `HTTP ${r.status}`);
          if (j.user?.id) $("userId").value = String(j.user.id);
          else out("User not found.");
        } catch(e){
          out(String(e?.message ?? e));
        }
      };

      $("btnCreate").onclick = async () => {
        try{
          const userId = Number($("userId").value);
          const title = $("title").value.trim();
          const zoomUrl = $("zoomUrl").value.trim();

          const r = computeStartEnd();
          if (!r) return out("Pick a date and start time.");
          if (r.bad) return out("End must be after start.");
          if (!userId) return out("Missing userId (use Find).");
          if (!title) return out("Missing title.");
          if (!zoomUrl) return out("Missing Zoom URL.");

          const body = {
            userId,
            title,
            start: r.start.toISOString(),
            end: r.end.toISOString(),
            zoomUrl,
          };

          const resp = await fetch(`/meetings`, {
            method: "POST",
            headers: { "Content-Type":"application/json", ...headers() },
            body: JSON.stringify(body),
          });

          const json = await resp.json().catch(()=> ({}));
          out(json);
          if (!resp.ok) throw new Error(json?.error ?? `HTTP ${resp.status}`);

        } catch(e){
          out(String(e?.message ?? e));
        }
      };

      initDefaults();
      syncKeyBadge();
      updatePreview();
    </script>
  </body>
</html>
