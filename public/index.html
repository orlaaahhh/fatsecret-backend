<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Admin â€¢ Meetings</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <style>
      :root{
        --bg:#f6f8fb;
        --card:#ffffff;
        --text:#0f172a;
        --muted:#64748b;
        --line:#e5e7eb;
        --soft:#f1f5f9;

        --primary:#2563eb;
        --primarySoft:#eff6ff;

        --danger:#dc2626;
        --dangerSoft:#fef2f2;

        --radius:14px;
      }

      *{ box-sizing:border-box; }
      html,body{ height:100%; }
      body{
        margin:0;
        background:var(--bg);
        color:var(--text);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      .wrap{
        max-width: 980px;
        margin: 28px auto;
        padding: 0 16px 40px;
      }

      .topbar{
        display:flex;
        align-items:flex-start;
        justify-content:space-between;
        gap:12px;
        margin-bottom: 14px;
      }

      .title{
        font-size:18px;
        font-weight:800;
        letter-spacing:-0.2px;
      }
      .subtitle{
        margin-top:6px;
        font-size:13px;
        color:var(--muted);
        font-weight:600;
      }

      .badge{
        display:inline-flex;
        align-items:center;
        gap:8px;
        padding:10px 12px;
        border:1px solid var(--line);
        border-radius:999px;
        background:var(--card);
        color:var(--muted);
        font-size:12px;
        font-weight:700;
        white-space:nowrap;
      }
      .badge.ok{
        border-color: rgba(37,99,235,0.25);
        background: var(--primarySoft);
        color: #1d4ed8;
      }
      .badge.bad{
        border-color: rgba(220,38,38,0.20);
        background: var(--dangerSoft);
        color: var(--danger);
      }

      .grid{
        display:grid;
        grid-template-columns: 1.15fr 0.85fr;
        gap:14px;
      }
      @media (max-width: 940px){
        .grid{ grid-template-columns: 1fr; }
      }

      .card{
        background:var(--card);
        border:1px solid var(--line);
        border-radius: var(--radius);
        padding: 16px;
      }

      .cardHeader{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:12px;
        margin-bottom: 12px;
      }

      h3{
        margin:0;
        font-size:13px;
        font-weight:800;
        color:var(--text);
        letter-spacing:0.2px;
        text-transform: uppercase;
      }

      .divider{
        height:1px;
        background:var(--line);
        margin: 14px 0;
      }

      label{
        display:block;
        margin: 10px 0 6px;
        font-size:12px;
        font-weight:700;
        color: var(--muted);
      }

      input{
        width:100%;
        height:44px;
        padding: 10px 12px;
        border-radius: 12px;
        border:1px solid var(--line);
        background:#fff;
        color: var(--text);
        font-size:14px;
        font-weight:600;
        outline:none;
      }
      input::placeholder{ color:#94a3b8; font-weight:600; }
      input:focus{
        border-color: rgba(37,99,235,0.45);
        box-shadow: 0 0 0 4px rgba(37,99,235,0.10);
      }

      .row{
        display:flex;
        gap:12px;
      }
      .row > *{ flex:1; }

      .actions{
        display:flex;
        gap:10px;
        margin-top: 14px;
      }

      button{
        height:44px;
        padding: 0 14px;
        border-radius: 12px;
        border:1px solid var(--line);
        background: #fff;
        color: var(--text);
        font-size:13px;
        font-weight:800;
        cursor:pointer;
      }
      button:hover{ background: var(--soft); }

      .btnPrimary{
        border-color: rgba(37,99,235,0.25);
        background: var(--primary);
        color:#fff;
      }
      .btnPrimary:hover{
        background: #1d4ed8;
      }

      .btnGhost{
        background:#fff;
      }

      .btnDanger{
        border-color: rgba(220,38,38,0.20);
        background: var(--dangerSoft);
        color: var(--danger);
      }
      .btnDanger:hover{
        background: #fee2e2;
      }

      .muted{
        color:var(--muted);
        font-size:12px;
        font-weight:700;
      }

      .mono{
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      }

      .out{
        height: 420px;
        overflow:auto;
        padding: 12px;
        border-radius: 12px;
        border:1px solid var(--line);
        background: #fbfcfe;
        white-space: pre-wrap;
        word-break: break-word;
        font-size: 12px;
        line-height: 1.45;
      }

      .preview{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:12px;
        margin-top: 12px;
        padding: 10px 12px;
        border-radius: 12px;
        border:1px solid var(--line);
        background: #fbfcfe;
      }
      .preview strong{
        font-size:12px;
        text-transform: uppercase;
        letter-spacing: 0.2px;
      }
      .previewText{
        font-size:12px;
        font-weight:700;
        color: var(--muted);
        text-align:right;
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <div class="topbar">
        <div>
          <div class="title">Admin</div>
          <div class="subtitle">Create Zoom meetings for users. Date/time uses your device timezone (Boston / New York).</div>
        </div>
        <div class="badge bad" id="keyBadge">Admin key: not set</div>
      </div>

      <div class="grid">
        <!-- FORM -->
        <div class="card">
          <div class="cardHeader">
            <h3>Create meeting</h3>
            <button class="btnDanger" id="btnReset" type="button">Reset</button>
          </div>

          <label>Admin API Key</label>
          <input id="adminKey" placeholder="ADMIN_API_KEY" autocomplete="off" />

          <div class="divider"></div>

          <label>User email</label>
          <div class="row">
            <input id="email" placeholder="user@email.com" autocomplete="off" />
            <button class="btnGhost" id="btnFind" type="button">Find</button>
          </div>

          <label>User ID</label>
          <input id="userId" placeholder="Auto-filled" inputmode="numeric" />

          <div class="divider"></div>

          <label>Title</label>
          <input id="title" placeholder="Weekly Check-in" />

          <label>Zoom URL</label>
          <input id="zoomUrl" placeholder="https://zoom.us/j/..." />

          <div class="row">
            <div>
              <label>Date</label>
              <input id="date" type="date" />
            </div>
            <div>
              <label>Start</label>
              <input id="start" type="time" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>Duration (min)</label>
              <input id="duration" type="number" min="5" step="5" value="30" />
            </div>
            <div>
              <label>End (optional)</label>
              <input id="end" type="time" />
            </div>
          </div>

          <div class="preview">
            <strong id="previewBadge">Preview</strong>
            <div class="previewText mono" id="previewText">Start: -   End: -</div>
          </div>

          <div class="actions">
            <button class="btnPrimary" id="btnCreate" type="button">Create</button>
          </div>
        </div>

        <!-- OUTPUT -->
        <div class="card">
          <div class="cardHeader">
            <h3>Response</h3>
            <div class="muted mono">POST /meetings</div>
          </div>
          <div class="out mono" id="out">-</div>
        </div>
      </div>
    </div>

    <script>
      const $ = (id) => document.getElementById(id);
      const outEl = $("out");
      const keyBadge = $("keyBadge");
      const previewBadge = $("previewBadge");
      const previewText = $("previewText");

      function out(x){
        outEl.textContent = typeof x === "string" ? x : JSON.stringify(x, null, 2);
      }

      function adminKey(){
        return ($("adminKey").value || "").trim();
      }

      function syncKeyBadge(){
        const k = adminKey();
        if (k.length >= 8){
          keyBadge.className = "badge ok";
          keyBadge.textContent = "Admin key: set";
        } else {
          keyBadge.className = "badge bad";
          keyBadge.textContent = "Admin key: not set";
        }
      }

      function headers(){
        const k = adminKey();
        if (!k) throw new Error("Missing admin key.");
        return { "x-admin-key": k };
      }

      function parseLocalDateTime(dateStr, timeStr){
        const [y,m,d] = dateStr.split("-").map(Number);
        const [hh,mm] = timeStr.split(":").map(Number);
        const dt = new Date();
        dt.setFullYear(y, m-1, d);
        dt.setHours(hh, mm, 0, 0);
        return dt;
      }

      function computeStartEnd(){
        const dateStr = $("date").value;
        const startStr = $("start").value;
        const endStr = $("end").value;
        const dur = Number($("duration").value || 30);

        if (!dateStr || !startStr) return null;

        const start = parseLocalDateTime(dateStr, startStr);
        let end;

        if (endStr){
          end = parseLocalDateTime(dateStr, endStr);
        } else {
          end = new Date(start.getTime() + Math.max(5, dur) * 60 * 1000);
        }

        if (!(end > start)) return { bad:true, start, end };
        return { start, end };
      }

      function updatePreview(){
        const r = computeStartEnd();
        if (!r){
          previewBadge.textContent = "Preview";
          previewBadge.style.color = "#64748b";
          previewText.textContent = "Start: -   End: -";
          return;
        }
        previewBadge.textContent = r.bad ? "Check" : "Ready";
        previewBadge.style.color = r.bad ? "#dc2626" : "#16a34a";
        previewText.textContent = `Start: ${r.start.toISOString()}   End: ${r.end.toISOString()}`;
      }

      function initDefaults(){
        const now = new Date();
        const yyyy = now.getFullYear();
        const mm = String(now.getMonth()+1).padStart(2,"0");
        const dd = String(now.getDate()).padStart(2,"0");
        $("date").value = `${yyyy}-${mm}-${dd}`;

        const rounded = new Date(now);
        rounded.setMinutes(Math.ceil(rounded.getMinutes() / 15) * 15);
        rounded.setSeconds(0,0);
        const hh = String(rounded.getHours()).padStart(2,"0");
        const mi = String(rounded.getMinutes()).padStart(2,"0");
        $("start").value = `${hh}:${mi}`;

        $("duration").value = "30";
        $("end").value = "";
      }

      $("adminKey").addEventListener("input", () => {
        syncKeyBadge();
      });

      ["date","start","end","duration"].forEach((id)=>{
        $(id).addEventListener("input", updatePreview);
        $(id).addEventListener("change", updatePreview);
      });

      $("btnReset").onclick = () => {
        $("adminKey").value = "";
        $("email").value = "";
        $("userId").value = "";
        $("title").value = "";
        $("zoomUrl").value = "";
        initDefaults();
        out("-");
        syncKeyBadge();
        updatePreview();
      };

      $("btnFind").onclick = async () => {
        try{
          const email = $("email").value.trim().toLowerCase();
          if (!email) return out("Enter an email.");

          const r = await fetch(`/admin/users?email=${encodeURIComponent(email)}`, { headers: headers() });
          const j = await r.json().catch(()=> ({}));

          out(j);
          if (!r.ok) throw new Error(j?.error ?? `HTTP ${r.status}`);

          $("userId").value = j.user?.id ? String(j.user.id) : "";
        } catch(e){
          out(String(e?.message ?? e));
        }
      };

      $("btnCreate").onclick = async () => {
        try{
          const userId = Number($("userId").value);
          const title = $("title").value.trim();
          const zoomUrl = $("zoomUrl").value.trim();

          const r = computeStartEnd();
          if (!r) return out("Pick a date and start time.");
          if (r.bad) return out("End must be after start.");
          if (!userId) return out("Missing userId (use Find).");
          if (!title) return out("Missing title.");
          if (!zoomUrl) return out("Missing Zoom URL.");

          const body = {
            userId,
            title,
            start: r.start.toISOString(),
            end: r.end.toISOString(),
            zoomUrl,
          };

          const resp = await fetch(`/meetings`, {
            method: "POST",
            headers: { "Content-Type":"application/json", ...headers() },
            body: JSON.stringify(body),
          });

          const json = await resp.json().catch(()=> ({}));
          out(json);
          if (!resp.ok) throw new Error(json?.error ?? `HTTP ${resp.status}`);

        } catch(e){
          out(String(e?.message ?? e));
        }
      };

      initDefaults();
      syncKeyBadge();
      updatePreview();
    </script>
  </body>
</html>
